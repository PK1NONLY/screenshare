<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Extension Permissions Debug</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status-card { 
            margin: 15px 0; 
            padding: 15px; 
            border-radius: 5px; 
            border-left: 4px solid #ccc;
        }
        .success { 
            background: #d4edda; 
            color: #155724; 
            border-left-color: #28a745;
        }
        .error { 
            background: #f8d7da; 
            color: #721c24; 
            border-left-color: #dc3545;
        }
        .warning { 
            background: #fff3cd; 
            color: #856404; 
            border-left-color: #ffc107;
        }
        .info { 
            background: #d1ecf1; 
            color: #0c5460; 
            border-left-color: #17a2b8;
        }
        button { 
            margin: 5px; 
            padding: 10px 15px; 
            border: none;
            border-radius: 4px;
            background: #007bff;
            color: white;
            cursor: pointer;
        }
        button:hover { background: #0056b3; }
        .code { 
            background: #f8f9fa; 
            padding: 10px; 
            border-radius: 4px; 
            font-family: monospace;
            margin: 10px 0;
            white-space: pre-wrap;
        }
        .step {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        .step h3 {
            margin-top: 0;
            color: #495057;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Extension Permissions Debug</h1>
        <p>This page will help debug extension permission and loading issues.</p>
        
        <div class="step">
            <h3>Chrome Extension API Detailed Check</h3>
            <button onclick="checkChromeAPIs()">Check All Chrome APIs</button>
            <div id="chrome-apis" class="status-card info">
                <strong>Click the button above to check Chrome APIs</strong>
            </div>
        </div>
        
        <div class="step">
            <h3>Extension Runtime Information</h3>
            <button onclick="checkExtensionRuntime()">Check Extension Runtime</button>
            <div id="extension-runtime" class="status-card info">
                <strong>Click the button above to check extension runtime</strong>
            </div>
        </div>
        
        <div class="step">
            <h3>Content Script Loading Debug</h3>
            <button onclick="debugContentScripts()">Debug Content Scripts</button>
            <div id="content-debug" class="status-card info">
                <strong>Click the button above to debug content scripts</strong>
            </div>
        </div>
        
        <div class="step">
            <h3>Console Errors Check</h3>
            <div class="status-card warning">
                <strong>Manual Check Required:</strong><br>
                1. Open DevTools (F12)<br>
                2. Go to Console tab<br>
                3. Look for any red error messages<br>
                4. Check for messages starting with [STE] or extension-related errors<br>
                5. If you see errors, copy them and share for analysis
            </div>
        </div>
        
        <div class="step">
            <h3>Extension Installation Verification</h3>
            <div class="status-card info">
                <strong>Manual Steps:</strong><br>
                1. Go to <code>chrome://extensions/</code><br>
                2. Find "Secure Testing Environment" extension<br>
                3. Check if there are any error messages in red<br>
                4. Click "Details" button<br>
                5. Scroll down to "Permissions" section<br>
                6. Verify all permissions are granted<br>
                7. If you see "This extension may not have all permissions", click "Allow"
            </div>
        </div>
    </div>

    <script>
        function checkChromeAPIs() {
            const result = document.getElementById('chrome-apis');
            let html = '<strong>Chrome API Detailed Check:</strong><br>';
            
            if (typeof chrome === 'undefined') {
                html += '‚ùå Chrome object not available<br>';
                result.innerHTML = html;
                result.className = 'status-card error';
                return;
            }
            
            html += '‚úÖ Chrome object available<br>';
            
            // Check all Chrome APIs we need
            const apis = [
                'runtime',
                'tabs', 
                'storage',
                'system',
                'scripting',
                'webNavigation',
                'webRequest',
                'declarativeNetRequest',
                'desktopCapture',
                'notifications',
                'power',
                'sessions',
                'topSites',
                'management',
                'privacy',
                'contentSettings',
                'debugger',
                'commands'
            ];
            
            let availableCount = 0;
            apis.forEach(api => {
                if (chrome[api]) {
                    html += `‚úÖ chrome.${api} available<br>`;
                    availableCount++;
                } else {
                    html += `‚ùå chrome.${api} not available<br>`;
                }
            });
            
            html += `<br><strong>Summary: ${availableCount}/${apis.length} APIs available</strong><br>`;
            
            if (availableCount < apis.length) {
                html += '<br><div class="code">Missing APIs suggest permission issues or extension not fully loaded.</div>';
                result.className = 'status-card warning';
            } else {
                result.className = 'status-card success';
            }
            
            result.innerHTML = html;
        }
        
        function checkExtensionRuntime() {
            const result = document.getElementById('extension-runtime');
            let html = '<strong>Extension Runtime Information:</strong><br>';
            
            if (typeof chrome === 'undefined' || !chrome.runtime) {
                html += '‚ùå Chrome runtime not available<br>';
                result.innerHTML = html;
                result.className = 'status-card error';
                return;
            }
            
            try {
                html += `‚úÖ Extension ID: ${chrome.runtime.id}<br>`;
                html += `‚úÖ Extension URL: ${chrome.runtime.getURL('')}<br>`;
                
                // Check if we can get manifest
                const manifest = chrome.runtime.getManifest();
                if (manifest) {
                    html += `‚úÖ Manifest loaded: ${manifest.name} v${manifest.version}<br>`;
                    html += `üìã Permissions requested: ${manifest.permissions.length}<br>`;
                    html += `üìã Content scripts: ${manifest.content_scripts ? manifest.content_scripts.length : 0}<br>`;
                    
                    html += '<br><strong>Requested Permissions:</strong><br>';
                    html += '<div class="code">' + manifest.permissions.join(', ') + '</div>';
                } else {
                    html += '‚ùå Could not load manifest<br>';
                }
                
                result.className = 'status-card success';
            } catch (error) {
                html += `‚ùå Error getting runtime info: ${error.message}<br>`;
                result.className = 'status-card error';
            }
            
            result.innerHTML = html;
        }
        
        function debugContentScripts() {
            const result = document.getElementById('content-debug');
            let html = '<strong>Content Script Debug:</strong><br>';
            
            // Check for content script objects
            const contentScripts = [
                { name: 'STELogger', obj: window.STELogger },
                { name: 'STEKeyboardTracker', obj: window.STEKeyboardTracker },
                { name: 'STESecurityEnforcer', obj: window.STESecurityEnforcer },
                { name: 'STEPageMonitor', obj: window.STEPageMonitor }
            ];
            
            let loadedCount = 0;
            contentScripts.forEach(script => {
                if (script.obj) {
                    html += `‚úÖ ${script.name} loaded<br>`;
                    loadedCount++;
                    
                    // Try to get more info about the object
                    try {
                        if (typeof script.obj === 'object' && script.obj.constructor) {
                            html += `   üìã Type: ${script.obj.constructor.name}<br>`;
                        }
                        if (script.obj.isActive !== undefined) {
                            html += `   üìã Active: ${script.obj.isActive}<br>`;
                        }
                    } catch (e) {
                        // Ignore errors getting object info
                    }
                } else {
                    html += `‚ùå ${script.name} not found<br>`;
                }
            });
            
            html += `<br><strong>Summary: ${loadedCount}/${contentScripts.length} content scripts loaded</strong><br>`;
            
            if (loadedCount === 0) {
                html += '<br><div class="code">No content scripts loaded suggests:<br>';
                html += '1. Extension not properly installed<br>';
                html += '2. Content script injection failed<br>';
                html += '3. JavaScript errors in content scripts<br>';
                html += '4. Permission issues preventing script injection</div>';
                result.className = 'status-card error';
            } else if (loadedCount < contentScripts.length) {
                html += '<br><div class="code">Partial loading suggests some content scripts have errors</div>';
                result.className = 'status-card warning';
            } else {
                html += '<br>üéâ All content scripts loaded successfully!';
                result.className = 'status-card success';
            }
            
            // Check for any STE-related console messages
            html += '<br><br><strong>Console Check:</strong><br>';
            html += 'Open DevTools Console and look for:<br>';
            html += '<div class="code">[STE] Logger initialized<br>';
            html += '[STE] Security Enforcer initialized<br>';
            html += '[STE] Keyboard Tracker initialized<br>';
            html += '[STE] Page Monitor initialized</div>';
            
            result.innerHTML = html;
        }
        
        // Auto-run basic checks on page load
        window.addEventListener('load', () => {
            setTimeout(() => {
                checkChromeAPIs();
            }, 1000);
        });
    </script>
</body>
</html>